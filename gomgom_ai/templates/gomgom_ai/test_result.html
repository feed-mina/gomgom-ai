{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>_ëœë¤ë°¥ìƒ</title>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac17c741aa8131e12604eac5e2d0441c&libraries=services&autoload=false"></script>
    <link rel="stylesheet" href="{% static 'css/randomfood.css' %}">
    <!--    <script src = "../javascript/elice.json" type="text/javascript"></script>-->
</head>
<body>

{% include 'gomgom_ai/loading.html' %}
<div class="background">
    <div class="header">
        <h3>
            <a href="{% url 'main' %}">
                <img id="logo" src="{% static 'image/logo.png' %}" alt="logo">

                <span class="header_text">&nbsp;CLICK YOUR TASTE!</span>
            </a>
        </h3>
    </div>
    <!-- ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ -->
    <div id="loading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="main">
            <div class="heading2">
                <h2>ë‹¹ì‹ ì—ê²Œ ë”± ë§ëŠ” ìŒì‹ì€?</h2>
                <!-- í˜„ì¬ ì£¼ì†Œ ì¶œë ¥ -->
                <p id="current-address" style="font-weight: bold; font-size: 16px; color: #222;">
                    ë¡œë”© ì¤‘...
                </p>

            </div>
            <div class="result">
                <img class="resultImg" src="{% static 'image/rabbit_chef_body2.png' %}" alt="í† ë¼">
                <div class="sideinfo">
                 <h2>ì˜¤ëŠ˜ì˜ ì¶”ì²œ ê°€ê²Œ</h2>
                 <h3 class="selected-store"> {{ result.store }}</h3>
                 <p class="selected-description"><strong> {{ result.description }}</strong></p>
             </div>
            </div>
            <div id="infotext">
                <p><strong>ì…ë ¥ í…ìŠ¤íŠ¸:</strong> {{ text }}</p>
                <p><strong>í…ŒìŠ¤íŠ¸ ê²°ê³¼:</strong> {{ types }}</p>
                <p><strong>ì¹´í…Œê³ ë¦¬:</strong> <span id="categoryText">{{ result.category }}</span></p>
                <p><strong>í‚¤ì›Œë“œ:</strong> <span id="keywordsText">{{ result.keywords }}</span></p>
            </div>

            <a href="{% url 'main' %}"><button style="width:10rem;" class="othermenu">ë‹¤ì‹œí•˜ê¸°</button></a>
<!--            <button type="button"  class="replayButton" onclick="showAnotherRestaurant()">ë‹¤ë¥¸ ì¶”ì²œë³´ê¸°</button>-->

            <!-- ë””ë²„ê¹…ìš© GPT ì •ë³´ í‘œì‹œ -->
            {% if DEBUG %}
            <div style="background-color:#FAF0D7; padding:10px; margin-top:20px;">
                <h3>ğŸ§ª ë””ë²„ê¹… ì •ë³´</h3>
                <!-- ë””ë²„ê¹…ìš© í…ìŠ¤íŠ¸ ì¶œë ¥ -->
                <p><strong>ì…ë ¥ í…ìŠ¤íŠ¸:</strong> {{ text }}</p>
                <p><strong>ìœ„ì¹˜:</strong> ìœ„ë„: {{ lat }}, ê²½ë„: {{ lng }}</p>
                <p><strong>ê¸°ë¶„ íƒœê·¸:</strong> {{ types }}</p>
                <p><strong>íƒœê·¸ ì ìˆ˜:</strong> {{ score }}</p>
                <p><strong>ì¶”ì²œ ê°€ê²Œ:</strong> {{ result.store }}</p>
                <p><strong>ì„¤ëª…:</strong> {{ result.description }}</p>
                <p><strong>ì¹´í…Œê³ ë¦¬:</strong> {{ result.category }}</p>
                <p><strong>í‚¤ì›Œë“œ:</strong> {{ result.keywords }}</p>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<!-- ì•„ë˜ ë¶€ë¶„ì€ hiddenìœ¼ë¡œ ë Œë”ë§ë§Œ í•´ë†“ê³  JSì—ì„œ ì‚¬ìš© -->
<script id="restaurantData" type="application/json">
    {{ restaurants|safe }}
</script>
<script>
    const text = "{{ text|escapejs }}";  // í…œí”Œë¦¿ì—ì„œ 'text' ê°’ì„ JSë¡œ ë„˜ê¸°ê¸°
</script>

<script>
    function showAnotherRestaurant() {
        const data = JSON.parse(document.getElementById("restaurantData").textContent);
        console.log(data)
        if (!Array.isArray(data) || data.length === 0) {
            alert("ë‹¤ë¥¸ ì¶”ì²œ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢");
            return;
        }

        const random = data[Math.floor(Math.random() * data.length)];
        // ì„ íƒëœ ê°€ê²Œ ì •ë³´ ì—…ë°ì´íŠ¸

        document.querySelector(".selected-store").textContent = random.name || "ì¶”ì²œ ì—†ìŒ";
        document.querySelector(".selected-description").textContent =
            (random.address || "ì£¼ì†Œ ì—†ìŒ") + " / í‰ì : " + (random.review_avg || "ì—†ìŒ");

        // âœ… categoryì™€ keywordë„ ë°”ê¾¸ê¸°
        document.getElementById("categoryText").textContent = Array.isArray(random.categories)
            ? random.categories.join(', ')
            : (random.category || "ì •ë³´ ì—†ìŒ");

        document.getElementById("keywordsText").textContent = Array.isArray(random.keywords)
            ? random.keywords.join(', ')
            : (random.keywords || "ì •ë³´ ì—†ìŒ");
    }

    // í˜ì´ì§€ ë¡œë”© ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë³´ì´ê¸°
    window.addEventListener('load', function () {
        document.getElementById('loading').style.display = 'none';
    });

    // í¼ ì „ì†¡ ì‹œ ì• ë‹ˆë©”ì´ì…˜ ë³´ì´ê¸° (í•„ìš” ì‹œ)
    function showLoading() {
        document.getElementById('loading').style.display = 'flex';
    }



    kakao.maps.load(function () {
        // Django í…œí”Œë¦¿ ê°’ì´ ìˆ«ìë¡œ ë“¤ì–´ì˜¤ë„ë¡ ê°•ì œ ë³€í™˜
        const lat = parseFloat("{{ lat|default:'37.484934' }}");
        const lng = parseFloat("{{ lng|default:'126.981321' }}");

        console.log("ìœ„ë„:", lat, "ê²½ë„:", lng);

        const geocoder = new kakao.maps.services.Geocoder();
        const coord = new kakao.maps.LatLng(lat, lng);

        geocoder.coord2Address(coord.getLng(), coord.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const address = result[0].road_address
                    ? result[0].road_address.address_name
                    : result[0].address.address_name;

                console.log("ì£¼ì†Œ ë³€í™˜ ì„±ê³µ:", address);
                document.getElementById("current-address").innerText = "í˜„ì¬ ìœ„ì¹˜: " + address;
            } else {
                console.error("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:", status);
                document.getElementById("current-address").innerText = `ìœ„ë„: ${lat}, ê²½ë„: ${lng}`;
            }
        });
    });
    function redirectWithLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                // lat, lngë¥¼ ìˆ¨ê²¨ì„œ ê°€ì ¸ì˜¨ë‹¤
                const lat = new URLSearchParams(window.location.search).get('lat');
                const lng = new URLSearchParams(window.location.search).get('lng');

            // ê²°ê³¼ë¡œ ì´ë™
                const query = selectedTypes.map((t, i) => `type${i + 1}=${t}`).join('&');
                window.location.href = `/test_result/?${query}&lat=${lat}&lng=${lng}`;

                const userText = document.getElementById("text-input")?.value || "";
                window.location.href = `/test_result/?${query}&lat=${lat}&lng=${lng}`;
                showAnotherRestaurant()
            }, function (error) {
                console.log("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš” ğŸ˜¥");
                window.location.href = `/test_result/?lat=37.484934&lng=126.981321`;  // ì‚¬ë‹¹ì—­

            });
        } else {
            console.log("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
            window.location.href = `/test_result/?lat=37.484934&lng=126.981321`;  // ì‚¬ë‹¹ì—­

        }
    }


</script>

</body>
</html>

