{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ê°€ê²Œ ë¦¬ìŠ¤íŠ¸</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ac17c741aa8131e12604eac5e2d0441c&libraries=services&autoload=false"></script>

    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body style="background-color: #FAF0D7;">

{% include 'gomgom_ai/loading.html' %}
<h1 style="margin:1rem;  color: #222;">ğŸ¥„ ê·¼ì²˜ ë°°ë‹¬ ê°€ëŠ¥í•œ ê°€ê²Œ ëª©ë¡</h1>

<!-- í˜„ì¬ ì£¼ì†Œ ì¶œë ¥ -->
<h2 id="current-address" style="margin:1rem; font-weight: bold; color: #222;">
    ë¡œë”© ì¤‘...
</h2>
{% for r in restaurants %}
<div class="store-card">
    <img src="{{ r.logo_url }}" class="store-img" alt="{{ r.name }}">
    <div class="store-info">
        <div class="store-name">{{ r.name }} (â­ {{ r.review_avg }})</div>
        <div class="store-category">ì¹´í…Œê³ ë¦¬: {{ r.categories|join:', ' }}</div>
        <div class="store-delivery">ë°°ë‹¬ë¹„: {{ r.delivery_fee_to_display.basic }}</div>
        <div class="store-review">ë¦¬ë·° ìˆ˜: {{ r.review_count }}</div>
    </div>
</div>
{% empty %}
<p>ğŸ˜¢ ê·¼ì²˜ ê°€ê²Œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.</p>
{% endfor %}

</body>
</html>

<style>
    .store-card {
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 20px;
        margin: 20px;
        box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 20px;
        background-color: #fff;
    }

    .store-info {
        flex: 1;
    }

    .store-name {
        font-size: 22px;
        font-weight: bold;
    }

    .store-category,
    .store-delivery,
    .store-review {
        margin: 4px 0;
        color: #555;
    }

    .store-img {
        border-radius: 8px;
        width: 100px;
        height: auto;
    }

</style>
<script>
    let lat = {{ lat|default:"null" }};
    let lng = {{ lng|default:"null" }};

    async function fetchLatLngFromIP() {
        try {
            const response = await fetch('https://mindevprofile.kr/api/ip-location/');
            const data = await response.json();
            console.log("IPë¡œ ê°€ì ¸ì˜¨ ìœ„ì¹˜:", data.loc);
            if (data.loc) {
                const [latitude, longitude] = data.loc.split(',');
                lat = parseFloat(latitude);
                lng = parseFloat(longitude);
                console.log("IPê¸°ë°˜ ìœ„ë„:", lat, "ê²½ë„:", lng);
                loadMap();  // ìœ„ì¹˜ ë°›ì•„ì˜¤ë©´ ì§€ë„ ê·¸ë¦¬ê¸°
            } else {
                console.error('IPë¡œ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”');
            }
        } catch (error) {
            console.error('IP ìœ„ì¹˜ ìš”ì²­ ì‹¤íŒ¨', error);
        }
    }

    function loadMap() {
        kakao.maps.load(function () {
            const coord = new kakao.maps.LatLng(lat, lng);

            console.log("ìµœì¢… ì§€ë„ ì¢Œí‘œ:", coord);

            const geocoder = new kakao.maps.services.Geocoder();

            geocoder.coord2Address(coord.getLng(), coord.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const address = result[0].road_address
                        ? result[0].road_address.address_name
                        : result[0].address.address_name;

                    console.log("ì£¼ì†Œ ë³€í™˜ ì„±ê³µ:", address);
                    document.getElementById("current-address").innerText = "í˜„ì¬ ìœ„ì¹˜: " + address;
                } else {
                    console.error("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:", status);
                    document.getElementById("current-address").innerText = `ìœ„ë„: ${lat}, ê²½ë„: ${lng}`;
                }
            });
        });
    }

    // í˜ì´ì§€ ì—´ë¦¬ìë§ˆì ìë™ ì‹¤í–‰
    window.addEventListener('load', () => {
        if (lat === null || lng === null) {
            console.log("lat, lng ì—†ìŒ â†’ IPë¡œ ëŒ€ì‹  ê°€ì ¸ì˜¤ê¸°");
            fetchLatLngFromIP();
        } else {
            console.log("lat, lng ì´ë¯¸ ìˆìŒ â†’ ë°”ë¡œ ì§€ë„ ê·¸ë¦¬ê¸°");
            loadMap();
        }
    });
</script>
